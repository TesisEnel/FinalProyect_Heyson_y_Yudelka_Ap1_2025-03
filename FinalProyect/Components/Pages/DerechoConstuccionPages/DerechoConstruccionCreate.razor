@page "/construccion/create"
@rendermode InteractiveServer

@using FinalProyect.Models
@using FinalProyect.Services
@using FinalProyect.Data
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.Components.Forms

@inject DerechoConstruccionService ConstruccionService
@inject SolicitanteService SolicitanteService
@inject DocumentoService DocumentoService
@inject ReciboIngresoService ReciboService
@inject NavigationManager Nav
@inject UserManager<ApplicationUser> UserManager
@inject AuthenticationStateProvider AuthProvider

<h3 class="mb-4 text-primary fw-bold">Registrar Derecho a Construcción</h3>

@if (!string.IsNullOrWhiteSpace(ErrorMessage))
{
    <div class="alert alert-danger">@ErrorMessage</div>
}

<div class="card shadow p-4">

    <EditForm FormName="ConstruccionForm" Model="@Modelo" OnValidSubmit="Guardar">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <h5 class="text-primary mb-3">Datos del Solicitante</h5>

        <div class="mb-3">
            <label class="form-label fw-semibold">Nombre completo *</label>
            <InputText class="form-control" @bind-Value="SolicitanteProceso.NombreCompleto" />
        </div>

        <div class="mb-3">
            <label class="form-label fw-semibold">Cédula *</label>
            <InputText class="form-control" @bind-Value="SolicitanteProceso.Cedula" />
        </div>

        <div class="mb-3">
            <label class="form-label fw-semibold">Teléfono</label>
            <InputText class="form-control" @bind-Value="SolicitanteProceso.Telefono" />
        </div>

        <hr />

        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label fw-semibold">Fecha</label>
                <InputDate class="form-control" @bind-Value="Modelo.Fecha" />
            </div>

            <div class="col-md-6 mb-3">
                <label class="form-label fw-semibold">Hora</label>
                <input class="form-control" @bind="HoraTexto" readonly />
            </div>
        </div>

        <hr />

        <h5 class="text-primary mb-3">Recibo del inspector (opcional)</h5>

        <InputFile OnChange="OnReciboInspectorSelected" class="form-control" />

        <hr />

        <button type="submit" class="btn btn-success">
            <i class="fas fa-save"></i> Guardar y generar recibo
        </button>

    </EditForm>

</div>

@code {

    private DerechoConstruccion Modelo { get; set; } = new();
    private Solicitante SolicitanteProceso { get; set; } = new();

    private IBrowserFile? ReciboInspectorFile;
    string HoraTexto { get; set; } = DateTime.Now.ToString("hh:mm tt");
    string ErrorMessage = "";

    protected override void OnInitialized()
    {
        Modelo.Fecha = DateTime.Today;
        Modelo.Hora = DateTime.Now.TimeOfDay;
    }

    private void OnReciboInspectorSelected(InputFileChangeEventArgs e)
        => ReciboInspectorFile = e.File;

    private async Task<string> GetUserId()
    {
        var auth = await AuthProvider.GetAuthenticationStateAsync();
        var user = auth.User;

        if (user.Identity?.IsAuthenticated == true)
            return UserManager.GetUserId(user);

        return "";
    }

    private async Task Guardar()
    {
        try
        {
            Modelo.UsuarioId = await GetUserId();  

            Modelo.SolicitanteId = await SolicitanteService.ObtenerIdOcrear(SolicitanteProceso);

            Modelo.Hora = DateTime.Now.TimeOfDay;

            Modelo.Monto = ProcessPrices.GetPrice(ProcessType.DerechoConstruccion);

            int construccionId = await ConstruccionService.Crear(Modelo);

            if (ReciboInspectorFile != null)
            {
                using var stream = ReciboInspectorFile.OpenReadStream();
                await DocumentoService.SubirDocumentoAsync(
                    stream,
                    ReciboInspectorFile.Name,
                    DocumentType.ReciboInspector,
                    construccionId: construccionId
                );
            }

            var recibo = new ReciboIngreso
            {
                Concepto = Modelo.GetConcepto(),
                Monto = Modelo.Monto,
                MontoEnLetras = ProcessPrices.GetPriceText((int)Modelo.Monto),
                SolicitanteId = Modelo.SolicitanteId,
                FormaPago = "Efectivo",
                NumeroRecibo = new Random().Next(1000, 9999).ToString()
            };

            int reciboId = await ReciboService.Crear(recibo);

            Modelo.Id = construccionId;
            Modelo.ReciboIngresoId = reciboId;
            await ConstruccionService.Actualizar(Modelo);

            Nav.NavigateTo($"/recibo/create/{construccionId}/{ProcessType.DerechoConstruccion}");
        }
        catch (Exception ex)
        {
            ErrorMessage = "Ocurrió un error al guardar: " + ex.Message;
        }
    }
}
